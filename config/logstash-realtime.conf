# Logstash pipeline otimizada para baixa latência
input {
  kafka {
    bootstrap_servers => "kafka:29092"
    topics => ["kbnt-stock-updates"]
    consumer_threads => 8
    fetch_min_bytes => 1        # Mínimo para reduzir latência
    poll_timeout_ms => 50       # Poll rápido
  }
}

filter {
  # Processamento mínimo para reduzir latência
  json {
    source => "message"
  }
  
  mutate {
    add_field => { "[@metadata][index]" => "kbnt-logs-%{+yyyy.MM.dd.HH}" }
    add_field => { "ingestion_time" => "%{[@timestamp]}" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    
    # Configurações para baixa latência
    flush_size => 10          # Flush pequeno
    idle_flush_time => 1      # Flush a cada 1 segundo
    workers => 4              # Múltiplos workers
    
    # Sem template complexo para reduzir overhead
    template_overwrite => false
  }
}
