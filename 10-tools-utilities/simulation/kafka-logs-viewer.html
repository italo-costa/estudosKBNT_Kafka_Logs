<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä KBNT Kafka Logs Viewer - Enhanced Publication Logs</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #2c3e50;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .log-section {
            margin: 20px 0;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .log-entry {
            margin: 5px 0;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-attempt {
            border-left: 3px solid #f39c12;
        }

        .log-success {
            border-left: 3px solid #27ae60;
        }

        .log-failed {
            border-left: 3px solid #e74c3c;
        }

        .log-alert {
            border-left: 3px solid #ff6b35;
        }

        .log-metrics {
            border-left: 3px solid #3498db;
        }

        .log-commit {
            border-left: 3px solid #9b59b6;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .hash-display {
            background: #9b59b6;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
        }

        .topic-display {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }

        .time-display {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-display {
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-success {
            background: #27ae60;
            color: white;
        }

        .status-failed {
            background: #e74c3c;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 11px;
            color: #bdc3c7;
            text-transform: uppercase;
        }

        .filter-bar {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .filter-bar select,
        .filter-bar input {
            padding: 8px;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #2c3e50;
            color: #ecf0f1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä KBNT Kafka Publication Logs</h1>
            <p>Enhanced Microservice Publication Logging with Hash Tracking, Topic Monitoring & Commit Verification</p>
        </div>

        <div class="content">
            <!-- Statistics Dashboard -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-publications">0</div>
                    <div class="stat-label">Total Publications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successful-publications">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failed-publications">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-processing-time">0ms</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-hashes">0</div>
                    <div class="stat-label">Unique Message Hashes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-topics">0</div>
                    <div class="stat-label">Active Topics</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="alerts-generated">0</div>
                    <div class="stat-label">Alerts Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="producer-instances">1</div>
                    <div class="stat-label">Producer Instances</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-success" onclick="simulateStockOperations()">üöÄ Simular Opera√ß√µes de
                    Estoque</button>
                <button class="btn btn-warning" onclick="simulateHighVolumeTest()">‚ö° Teste de Alto Volume</button>
                <button class="btn btn-danger" onclick="simulateErrorScenarios()">‚ùå Simular Cen√°rios de Erro</button>
                <button class="btn" onclick="simulateLowStockAlerts()">‚ö†Ô∏è Simular Alertas de Estoque</button>
                <button class="btn btn-success" onclick="exportLogs()">üíæ Exportar Logs</button>
                <button class="btn btn-danger" onclick="clearAllLogs()">üóëÔ∏è Limpar Logs</button>
            </div>

            <!-- Filters -->
            <div class="filter-bar">
                <select id="topic-filter" onchange="filterLogs()">
                    <option value="">Todos os T√≥picos</option>
                    <option value="kbnt-stock-updates">kbnt-stock-updates</option>
                    <option value="kbnt-stock-transfers">kbnt-stock-transfers</option>
                    <option value="kbnt-stock-alerts">kbnt-stock-alerts</option>
                </select>
                <select id="status-filter" onchange="filterLogs()">
                    <option value="">Todos os Status</option>
                    <option value="SUCCESS">Success</option>
                    <option value="FAILED">Failed</option>
                    <option value="PENDING">Pending</option>
                </select>
                <input type="text" id="product-filter" placeholder="Product ID..." onkeyup="filterLogs()">
                <input type="text" id="hash-filter" placeholder="Message Hash..." onkeyup="filterLogs()">
            </div>

            <!-- Publication Attempt Logs -->
            <div class="log-section">
                <h3>üì§ Publication Attempts</h3>
                <div id="attempt-logs">
                    <div class="log-entry">Aguardando simula√ß√£o de opera√ß√µes...</div>
                </div>
            </div>

            <!-- Success Logs -->
            <div class="log-section">
                <h3>‚úÖ Successful Publications with Commit Details</h3>
                <div id="success-logs">
                    <div class="log-entry">Aguardando confirma√ß√µes de commit...</div>
                </div>
            </div>

            <!-- Failed Logs -->
            <div class="log-section">
                <h3>‚ùå Failed Publications</h3>
                <div id="failed-logs">
                    <div class="log-entry">Nenhuma falha registrada ainda...</div>
                </div>
            </div>

            <!-- Alert Logs -->
            <div class="log-section">
                <h3>‚ö†Ô∏è Low Stock Alert Logs</h3>
                <div id="alert-logs">
                    <div class="log-entry">Aguardando alertas de estoque baixo...</div>
                </div>
            </div>

            <!-- Metrics Logs -->
            <div class="log-section">
                <h3>üìä Structured Metrics</h3>
                <div id="metrics-logs">
                    <div class="log-entry">Aguardando m√©tricas estruturadas...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let publications = [];
        let messageHashes = new Set();
        let activeTopics = new Set();
        let processingTimes = [];
        let alertCount = 0;

        // Product catalog for realistic simulation
        const products = [
            'SMARTPHONE-XYZ123', 'TABLET-ABC456', 'NOTEBOOK-DEF789', 'HEADPHONE-GHI012',
            'SMARTWATCH-JKL345', 'SPEAKER-MNO678', 'CAMERA-PQR901', 'DRONE-STU234'
        ];

        const distributionCenters = ['DC-SP01', 'DC-RJ01', 'DC-MG01', 'DC-RS01'];
        const branches = [
            'FIL-SP001', 'FIL-SP002', 'FIL-SP003', 'FIL-RJ001', 'FIL-RJ002',
            'FIL-MG001', 'FIL-MG002', 'FIL-RS001', 'FIL-RS002'
        ];

        // Generate realistic message hash (SHA-256 simulation)
        function generateMessageHash(message) {
            const hashInput = `${message.timestamp}-${message.productId}-${message.operation}-${message.correlationId}`;
            let hash = 0;
            for (let i = 0; i < hashInput.length; i++) {
                const char = hashInput.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(16).substring(0, 16).padStart(16, '0');
        }

        // Generate producer ID
        function generateProducerId() {
            return 'kbnt-producer-' + Math.random().toString(36).substr(2, 8);
        }

        // Simulate stock operation
        function simulateStockOperation() {
            const operation = ['ADD', 'REMOVE', 'SET', 'TRANSFER'][Math.floor(Math.random() * 4)];
            const product = products[Math.floor(Math.random() * products.length)];
            const dc = distributionCenters[Math.floor(Math.random() * distributionCenters.length)];
            const branch = branches[Math.floor(Math.random() * branches.length)];

            const message = {
                publicationId: 'pub-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                productId: product,
                operation: operation,
                distributionCenter: dc,
                branch: branch,
                quantity: Math.floor(Math.random() * 100) + 1,
                timestamp: new Date().toISOString(),
                correlationId: 'corr-' + Date.now(),
                reasonCode: operation === 'ADD' ? 'PURCHASE' : operation === 'REMOVE' ? 'SALE' : 'ADJUSTMENT'
            };

            message.messageHash = generateMessageHash(message);
            message.topicName = determineTopicName(operation);
            message.partition = Math.floor(Math.random() * (operation === 'TRANSFER' ? 6 : 12));
            message.offset = Math.floor(Math.random() * 10000) + 1000;
            message.messageSizeBytes = JSON.stringify(message).length;
            message.producerId = generateProducerId();

            return message;
        }

        function determineTopicName(operation) {
            if (operation === 'TRANSFER') return 'kbnt-stock-transfers';
            return 'kbnt-stock-updates';
        }

        function logPublicationAttempt(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] üì§ [PUBLISH-ATTEMPT] ID=${message.publicationId} | Hash=${message.messageHash} | Topic=${message.topicName} | Product=${message.productId} | Operation=${message.operation} | Size=${message.messageSizeBytes}B | Producer=${message.producerId}`;

            addLogToSection('attempt-logs', logEntry, 'log-attempt');
        }

        function logSuccessfulPublication(message) {
            const timestamp = new Date().toLocaleTimeString();
            const processingTime = Math.floor(Math.random() * 100) + 20; // 20-120ms
            processingTimes.push(processingTime);

            const successLog = `[${timestamp}] ‚úÖ [PUBLISH-SUCCESS] ID=${message.publicationId} | Hash=${message.messageHash} | Topic=${message.topicName} | Partition=${message.partition} | Offset=${message.offset} | Time=${processingTime}ms | Commit=CONFIRMED`;

            const commitLog = `[${timestamp}] üéØ [KAFKA-COMMIT] ID=${message.publicationId} | Broker-Response=[Partition=${message.partition}, Offset=${message.offset}] | Ack-Time=${new Date().toISOString()} | Message-Hash=${message.messageHash}`;

            addLogToSection('success-logs', successLog, 'log-success');
            addLogToSection('success-logs', commitLog, 'log-commit');

            // Add to metrics
            const metricsLog = `[${timestamp}] üìä [METRICS] PublicationId=${message.publicationId} MessageHash=${message.messageHash} Topic=${message.topicName} Partition=${message.partition} Offset=${message.offset} ProcessingTimeMs=${processingTime} Status=SUCCESS Producer=${message.producerId}`;
            addLogToSection('metrics-logs', metricsLog, 'log-metrics');
        }

        function logFailedPublication(message, error) {
            const timestamp = new Date().toLocaleTimeString();
            const processingTime = Math.floor(Math.random() * 5000) + 1000; // 1-6 seconds for failures

            const failLog = `[${timestamp}] ‚ùå [PUBLISH-FAILED] ID=${message.publicationId} | Hash=${message.messageHash} | Topic=${message.topicName} | Error=${error} | Time=${processingTime}ms | Commit=FAILED`;

            const errorLog = `[${timestamp}] üí• [ERROR-DETAILS] ID=${message.publicationId} | Product=${message.productId} | Operation=${message.operation} | Exception=KafkaTimeoutException`;

            addLogToSection('failed-logs', failLog, 'log-failed');
            addLogToSection('failed-logs', errorLog, 'log-failed');

            // Add to metrics
            const metricsLog = `[${timestamp}] üìä [METRICS] PublicationId=${message.publicationId} MessageHash=${message.messageHash} Topic=${message.topicName} ProcessingTimeMs=${processingTime} Status=FAILED Error=${error.replace(/\s/g, '_')} Producer=${message.producerId}`;
            addLogToSection('metrics-logs', metricsLog, 'log-metrics');
        }

        function simulateLowStockAlert(message) {
            if (message.operation === 'REMOVE' && Math.random() < 0.3) {
                const alertId = 'alert-' + Date.now();
                const timestamp = new Date().toLocaleTimeString();
                const quantity = Math.floor(Math.random() * 8) + 1; // 1-8 (below threshold of 10)

                const alertAttemptLog = `[${timestamp}] ‚ö†Ô∏è [LOW-STOCK-ALERT] ID=${alertId} | Hash=${message.messageHash} | Product=${message.productId} | Location=${message.distributionCenter}-${message.branch} | Quantity=${quantity} | Threshold=10`;

                const alertPublishLog = `[${timestamp}] üì§ [ALERT-PUBLISH] ID=${alertId} | Hash=${message.messageHash} | Topic=kbnt-stock-alerts | Product=${message.productId} | Alert-Type=LOW_STOCK`;

                const alertSuccessLog = `[${timestamp}] ‚úÖ [ALERT-SUCCESS] ID=${alertId} | Hash=${message.messageHash} | Topic=kbnt-stock-alerts | Partition=${Math.floor(Math.random() * 4)} | Offset=${Math.floor(Math.random() * 5000)} | Time=${Math.floor(Math.random() * 30) + 10}ms`;

                addLogToSection('alert-logs', alertAttemptLog, 'log-alert');
                setTimeout(() => addLogToSection('alert-logs', alertPublishLog, 'log-alert'), 100);
                setTimeout(() => addLogToSection('alert-logs', alertSuccessLog, 'log-alert'), 200);

                alertCount++;
                updateStats();
            }
        }

        function addLogToSection(sectionId, logText, className) {
            const section = document.getElementById(sectionId);
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${className}`;
            logEntry.textContent = logText;

            section.insertBefore(logEntry, section.firstChild);

            // Keep only last 50 entries per section
            if (section.children.length > 50) {
                section.removeChild(section.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('total-publications').textContent = publications.length;
            document.getElementById('successful-publications').textContent = publications.filter(p => p.status === 'SUCCESS').length;
            document.getElementById('failed-publications').textContent = publications.filter(p => p.status === 'FAILED').length;
            document.getElementById('unique-hashes').textContent = messageHashes.size;
            document.getElementById('active-topics').textContent = activeTopics.size;
            document.getElementById('alerts-generated').textContent = alertCount;

            if (processingTimes.length > 0) {
                const avgTime = Math.round(processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length);
                document.getElementById('avg-processing-time').textContent = avgTime + 'ms';
            }
        }

        // Simulation functions
        function simulateStockOperations() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const message = simulateStockOperation();
                    publications.push(message);
                    messageHashes.add(message.messageHash);
                    activeTopics.add(message.topicName);

                    logPublicationAttempt(message);

                    // Simulate success/failure (95% success rate)
                    setTimeout(() => {
                        if (Math.random() < 0.95) {
                            message.status = 'SUCCESS';
                            logSuccessfulPublication(message);
                            simulateLowStockAlert(message);
                        } else {
                            message.status = 'FAILED';
                            const errors = ['Connection timeout', 'Broker unavailable', 'Serialization error', 'Authentication failed'];
                            logFailedPublication(message, errors[Math.floor(Math.random() * errors.length)]);
                        }
                        updateStats();
                    }, Math.random() * 1000 + 200);
                }, i * 500);
            }
        }

        function simulateHighVolumeTest() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const message = simulateStockOperation();
                    publications.push(message);
                    messageHashes.add(message.messageHash);
                    activeTopics.add(message.topicName);

                    if (i % 10 === 0) { // Log every 10th attempt
                        logPublicationAttempt(message);
                    }

                    setTimeout(() => {
                        if (Math.random() < 0.98) {
                            message.status = 'SUCCESS';
                            if (i % 10 === 0) {
                                logSuccessfulPublication(message);
                            }
                        } else {
                            message.status = 'FAILED';
                            logFailedPublication(message, 'High volume timeout');
                        }
                        updateStats();
                    }, Math.random() * 200 + 50);
                }, i * 100);
            }
        }

        function simulateErrorScenarios() {
            const errorTypes = [
                'Connection timeout',
                'Broker unavailable',
                'Serialization error',
                'Authentication failed',
                'Topic not found',
                'Insufficient permissions'
            ];

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const message = simulateStockOperation();
                    publications.push(message);
                    messageHashes.add(message.messageHash);
                    activeTopics.add(message.topicName);

                    logPublicationAttempt(message);

                    setTimeout(() => {
                        message.status = 'FAILED';
                        logFailedPublication(message, errorTypes[Math.floor(Math.random() * errorTypes.length)]);
                        updateStats();
                    }, Math.random() * 2000 + 500);
                }, i * 800);
            }
        }

        function simulateLowStockAlerts() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const message = simulateStockOperation();
                    message.operation = 'REMOVE'; // Force removal to trigger alert
                    publications.push(message);
                    messageHashes.add(message.messageHash);
                    activeTopics.add(message.topicName);

                    logPublicationAttempt(message);

                    setTimeout(() => {
                        message.status = 'SUCCESS';
                        logSuccessfulPublication(message);
                        simulateLowStockAlert(message); // Force alert
                        updateStats();
                    }, Math.random() * 500 + 200);
                }, i * 600);
            }
        }

        function filterLogs() {
            // Filtering logic would be implemented here
            // For demo purposes, just show a message
            console.log('Filtering logs...');
        }

        function exportLogs() {
            const logs = {
                timestamp: new Date().toISOString(),
                publications: publications,
                stats: {
                    totalPublications: publications.length,
                    successfulPublications: publications.filter(p => p.status === 'SUCCESS').length,
                    failedPublications: publications.filter(p => p.status === 'FAILED').length,
                    uniqueHashes: messageHashes.size,
                    activeTopics: Array.from(activeTopics),
                    alertsGenerated: alertCount,
                    averageProcessingTime: processingTimes.length > 0 ?
                        Math.round(processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length) : 0
                }
            };

            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kbnt-kafka-logs-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üìä Logs exportados com sucesso!');
        }

        function clearAllLogs() {
            ['attempt-logs', 'success-logs', 'failed-logs', 'alert-logs', 'metrics-logs'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="log-entry">Logs limpos...</div>';
            });

            publications = [];
            messageHashes.clear();
            activeTopics.clear();
            processingTimes = [];
            alertCount = 0;
            updateStats();
        }

        // Initialize
        updateStats();

        // Auto-generate some initial logs
        setTimeout(() => {
            simulateStockOperations();
        }, 2000);
    </script>
</body>

</html>