<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä KBNT Traffic Test - Teste de Tr√°fego de Mensagens</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2c3e50;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: #34495e;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .test-card h3 {
            color: #3498db;
            margin-top: 0;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .metric-label {
            font-size: 12px;
            color: #bdc3c7;
            text-transform: uppercase;
        }

        .log-container {
            background: #1a1a1a;
            border: 1px solid #34495e;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .log-info {
            color: #3498db;
        }

        .log-success {
            color: #27ae60;
        }

        .log-warning {
            color: #f39c12;
        }

        .log-error {
            color: #e74c3c;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #34495e;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        .realtime-chart {
            background: #34495e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä KBNT Traffic Test</h1>
            <p>Teste de Tr√°fego de Mensagens - Sistema de Estoque Kafka</p>
        </div>

        <div class="content">
            <!-- M√©tricas em Tempo Real -->
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="total-messages">0</div>
                    <div class="metric-label">Total de Mensagens</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="messages-per-sec">0</div>
                    <div class="metric-label">Mensagens/Segundo</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-latency">0ms</div>
                    <div class="metric-label">Lat√™ncia M√©dia</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="success-rate">0%</div>
                    <div class="metric-label">Taxa de Sucesso</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="topic-updates">0</div>
                    <div class="metric-label">Stock Updates</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="topic-transfers">0</div>
                    <div class="metric-label">Transfers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="topic-alerts">0</div>
                    <div class="metric-label">Alerts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="test-status">Parado</div>
                    <div class="metric-label">Status do Teste</div>
                </div>
            </div>

            <!-- Controles de Teste -->
            <div class="test-controls">
                <div class="test-card">
                    <h3>üöÄ Teste de Carga Baixa</h3>
                    <p>10 mensagens/segundo por 30 segundos</p>
                    <button class="btn btn-success" onclick="startLowTrafficTest()">Iniciar Teste Baixo</button>
                </div>

                <div class="test-card">
                    <h3>‚ö° Teste de Carga M√©dia</h3>
                    <p>50 mensagens/segundo por 60 segundos</p>
                    <button class="btn btn-warning" onclick="startMediumTrafficTest()">Iniciar Teste M√©dio</button>
                </div>

                <div class="test-card">
                    <h3>üî• Teste de Alto Tr√°fego</h3>
                    <p>200 mensagens/segundo por 120 segundos</p>
                    <button class="btn btn-danger" onclick="startHighTrafficTest()">Iniciar Teste Alto</button>
                </div>

                <div class="test-card">
                    <h3>üìä Teste de Estresse</h3>
                    <p>500 mensagens/segundo por 300 segundos</p>
                    <button class="btn btn-danger" onclick="startStressTest()">Teste de Estresse</button>
                </div>

                <div class="test-card">
                    <h3>üéØ Teste Personalizado</h3>
                    <div style="text-align: left; margin: 10px 0;">
                        <label>Msgs/seg: <input type="number" id="custom-rate" value="100" min="1"
                                max="1000"></label><br>
                        <label>Dura√ß√£o (s): <input type="number" id="custom-duration" value="60" min="10"
                                max="600"></label>
                    </div>
                    <button class="btn" onclick="startCustomTrafficTest()">Teste Personalizado</button>
                </div>

                <div class="test-card">
                    <h3>üõë Controles</h3>
                    <button class="btn btn-danger" onclick="stopAllTests()">Parar Todos os Testes</button>
                    <button class="btn" onclick="clearLogs()">Limpar Logs</button>
                    <button class="btn btn-success" onclick="exportResults()">Exportar Resultados</button>
                </div>
            </div>

            <!-- Barra de Progresso -->
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <span id="progress-text">Aguardando in√≠cio do teste...</span>
            </div>

            <!-- Gr√°fico em Tempo Real -->
            <div class="realtime-chart">
                <h3>üìà Throughput em Tempo Real</h3>
                <canvas id="throughput-chart" width="800" height="200"></canvas>
            </div>

            <!-- Log de Eventos -->
            <h3>üìù Log de Eventos em Tempo Real</h3>
            <div class="log-container" id="log-container"></div>
        </div>
    </div>

    <script>
        // Vari√°veis globais para controle do teste
        let testRunning = false;
        let testStartTime = 0;
        let totalMessages = 0;
        let successfulMessages = 0;
        let topicCounts = {
            updates: 0,
            transfers: 0,
            alerts: 0
        };
        let latencies = [];
        let currentTestInterval = null;
        let metricsInterval = null;
        let throughputData = [];
        let maxDataPoints = 60;

        // Configura√ß√£o do canvas para gr√°fico
        const canvas = document.getElementById('throughput-chart');
        const ctx = canvas.getContext('2d');

        // Produtos e localiza√ß√µes para simula√ß√£o real√≠stica
        const products = [
            'SMARTPHONE-A', 'SMARTPHONE-B', 'TABLET-X', 'TABLET-Y',
            'NOTEBOOK-PRO', 'NOTEBOOK-LITE', 'HEADPHONE-BT', 'SPEAKER-WIFI',
            'SMARTWATCH-S1', 'SMARTWATCH-S2', 'CAMERA-4K', 'DRONE-MINI'
        ];

        const distributionCenters = ['DC-SP01', 'DC-RJ01', 'DC-MG01', 'DC-RS01'];
        const branches = [
            'FIL-SP001', 'FIL-SP002', 'FIL-SP003', 'FIL-RJ001', 'FIL-RJ002',
            'FIL-MG001', 'FIL-MG002', 'FIL-RS001', 'FIL-RS002'
        ];

        // Fun√ß√£o para logging
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContainer.insertBefore(logEntry, logContainer.firstChild);

            // Manter apenas √∫ltimas 100 entradas
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Fun√ß√£o para gerar mensagem aleat√≥ria
        function generateRandomMessage() {
            const operations = ['ADD', 'REMOVE', 'TRANSFER'];
            const reasons = {
                'ADD': ['PURCHASE', 'RETURN', 'ADJUSTMENT'],
                'REMOVE': ['SALE', 'LOSS', 'DAMAGE'],
                'TRANSFER': ['REBALANCE', 'SUPPLY', 'URGENT']
            };

            const operation = operations[Math.floor(Math.random() * operations.length)];
            const product = products[Math.floor(Math.random() * products.length)];
            const dc = distributionCenters[Math.floor(Math.random() * distributionCenters.length)];
            const branch = branches[Math.floor(Math.random() * branches.length)];

            return {
                productId: product,
                distributionCenter: dc,
                branch: branch,
                sourceBranch: operation === 'TRANSFER' ? branches[Math.floor(Math.random() * branches.length)] : undefined,
                quantity: Math.floor(Math.random() * 100) + 1,
                operation: operation,
                reasonCode: reasons[operation][Math.floor(Math.random() * reasons[operation].length)],
                timestamp: new Date().toISOString(),
                correlationId: `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            };
        }

        // Fun√ß√£o para processar mensagem
        async function processMessage(message) {
            const startTime = performance.now();

            // Simular lat√™ncia de rede e processamento (20-100ms)
            const simulatedLatency = Math.random() * 80 + 20;

            return new Promise((resolve) => {
                setTimeout(() => {
                    const endTime = performance.now();
                    const actualLatency = endTime - startTime;
                    latencies.push(actualLatency);

                    // Simular taxa de sucesso de 95-99%
                    const success = Math.random() > 0.02;

                    if (success) {
                        successfulMessages++;

                        // Determinar t√≥pico baseado na opera√ß√£o
                        let topic;
                        if (message.operation === 'TRANSFER') {
                            topic = 'kbnt-stock-transfers';
                            topicCounts.transfers++;
                        } else {
                            topic = 'kbnt-stock-updates';
                            topicCounts.updates++;
                        }

                        // Simular alertas (10% das remo√ß√µes)
                        if (message.operation === 'REMOVE' && Math.random() < 0.1) {
                            topicCounts.alerts++;
                            addLog(`üö® ALERT: Estoque baixo detectado para ${message.productId} em ${message.branch}`, 'warning');
                        }

                        addLog(`‚úÖ ${message.operation} processado: ${message.productId} ‚Üí ${topic}`, 'success');
                    } else {
                        addLog(`‚ùå Falha no processamento: ${message.operation} ${message.productId}`, 'error');
                    }

                    totalMessages++;
                    resolve(success);
                }, simulatedLatency);
            });
        }

        // Fun√ß√£o para atualizar m√©tricas
        function updateMetrics() {
            const now = Date.now();
            const elapsedSeconds = (now - testStartTime) / 1000;
            const messagesPerSecond = elapsedSeconds > 0 ? (totalMessages / elapsedSeconds).toFixed(1) : 0;

            // Calcular lat√™ncia m√©dia
            const avgLatency = latencies.length > 0 ?
                (latencies.reduce((a, b) => a + b, 0) / latencies.length).toFixed(0) : 0;

            // Taxa de sucesso
            const successRate = totalMessages > 0 ?
                ((successfulMessages / totalMessages) * 100).toFixed(1) : 100;

            // Atualizar DOM
            document.getElementById('total-messages').textContent = totalMessages.toLocaleString();
            document.getElementById('messages-per-sec').textContent = messagesPerSecond;
            document.getElementById('avg-latency').textContent = avgLatency + 'ms';
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('topic-updates').textContent = topicCounts.updates.toLocaleString();
            document.getElementById('topic-transfers').textContent = topicCounts.transfers.toLocaleString();
            document.getElementById('topic-alerts').textContent = topicCounts.alerts.toLocaleString();

            // Atualizar dados do gr√°fico
            throughputData.push(parseFloat(messagesPerSecond));
            if (throughputData.length > maxDataPoints) {
                throughputData.shift();
            }

            drawThroughputChart();
        }

        // Fun√ß√£o para desenhar gr√°fico
        function drawThroughputChart() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (throughputData.length < 2) return;

            const maxThroughput = Math.max(...throughputData, 100);
            const stepX = canvas.width / (maxDataPoints - 1);
            const stepY = canvas.height / maxThroughput;

            // Desenhar grid
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 1;

            // Linhas horizontais
            for (let i = 0; i <= 5; i++) {
                const y = (canvas.height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // Desenhar linha do throughput
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i < throughputData.length; i++) {
                const x = i * stepX;
                const y = canvas.height - (throughputData[i] * stepY);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.stroke();

            // Desenhar valores no eixo Y
            ctx.fillStyle = '#bdc3c7';
            ctx.font = '10px sans-serif';
            for (let i = 0; i <= 5; i++) {
                const value = (maxThroughput / 5) * (5 - i);
                const y = (canvas.height / 5) * i;
                ctx.fillText(value.toFixed(0), 5, y + 12);
            }
        }

        // Fun√ß√£o para executar teste de tr√°fego
        function executeTrafficTest(messagesPerSecond, durationSeconds, testName) {
            if (testRunning) {
                addLog('‚ùå Teste j√° em execu√ß√£o. Pare o teste atual primeiro.', 'error');
                return;
            }

            testRunning = true;
            testStartTime = Date.now();
            totalMessages = 0;
            successfulMessages = 0;
            topicCounts = { updates: 0, transfers: 0, alerts: 0 };
            latencies = [];
            throughputData = [];

            document.getElementById('test-status').textContent = 'Executando';
            addLog(`üöÄ Iniciando ${testName}: ${messagesPerSecond} msg/s por ${durationSeconds}s`, 'info');

            const intervalMs = 1000 / messagesPerSecond;
            const totalExpectedMessages = messagesPerSecond * durationSeconds;
            let messagesSent = 0;

            // Atualizar m√©tricas a cada segundo
            metricsInterval = setInterval(updateMetrics, 1000);

            // Fun√ß√£o para enviar mensagens
            const sendMessages = () => {
                if (!testRunning || messagesSent >= totalExpectedMessages) {
                    stopAllTests();
                    return;
                }

                const message = generateRandomMessage();
                processMessage(message);
                messagesSent++;

                // Atualizar progresso
                const progress = (messagesSent / totalExpectedMessages) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-text').textContent =
                    `Progresso: ${messagesSent}/${totalExpectedMessages} mensagens (${progress.toFixed(1)}%)`;

                // Agendar pr√≥xima mensagem
                currentTestInterval = setTimeout(sendMessages, intervalMs);
            };

            // Iniciar envio de mensagens
            sendMessages();

            // Parar automaticamente ap√≥s dura√ß√£o especificada
            setTimeout(() => {
                if (testRunning) {
                    stopAllTests();
                    addLog(`‚úÖ ${testName} conclu√≠do com sucesso!`, 'success');
                }
            }, durationSeconds * 1000 + 1000); // +1s de buffer
        }

        // Fun√ß√µes dos testes espec√≠ficos
        function startLowTrafficTest() {
            executeTrafficTest(10, 30, 'Teste de Carga Baixa');
        }

        function startMediumTrafficTest() {
            executeTrafficTest(50, 60, 'Teste de Carga M√©dia');
        }

        function startHighTrafficTest() {
            executeTrafficTest(200, 120, 'Teste de Alto Tr√°fego');
        }

        function startStressTest() {
            executeTrafficTest(500, 300, 'Teste de Estresse');
        }

        function startCustomTrafficTest() {
            const rate = parseInt(document.getElementById('custom-rate').value);
            const duration = parseInt(document.getElementById('custom-duration').value);

            if (rate < 1 || rate > 1000 || duration < 10 || duration > 600) {
                addLog('‚ùå Par√¢metros inv√°lidos. Rate: 1-1000, Duration: 10-600', 'error');
                return;
            }

            executeTrafficTest(rate, duration, 'Teste Personalizado');
        }

        function stopAllTests() {
            testRunning = false;

            if (currentTestInterval) {
                clearTimeout(currentTestInterval);
                currentTestInterval = null;
            }

            if (metricsInterval) {
                clearInterval(metricsInterval);
                metricsInterval = null;
            }

            document.getElementById('test-status').textContent = 'Parado';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Teste interrompido.';

            addLog('üõë Todos os testes foram interrompidos', 'warning');
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLog('üìù Logs limpos', 'info');
        }

        function exportResults() {
            const avgLatency = latencies.length > 0 ?
                (latencies.reduce((a, b) => a + b, 0) / latencies.length).toFixed(2) : 0;
            const successRate = totalMessages > 0 ?
                ((successfulMessages / totalMessages) * 100).toFixed(2) : 0;

            const results = {
                timestamp: new Date().toISOString(),
                totalMessages: totalMessages,
                successfulMessages: successfulMessages,
                successRate: successRate + '%',
                averageLatency: avgLatency + 'ms',
                topicCounts: topicCounts,
                throughputData: throughputData.slice()
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kbnt-traffic-test-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('üìä Resultados exportados com sucesso', 'success');
        }

        // Inicializa√ß√£o
        addLog('üè™ KBNT Traffic Test inicializado', 'info');
        addLog('üìã Sistema pronto para testes de tr√°fego', 'success');
        updateMetrics();
    </script>
</body>

</html>